# SPDX-FileCopyrightText: 2025 Christina SÃ¸rensen
#
# SPDX-License-Identifier: EUPL-1.2
name: "Automated Dependency Bump"
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 4'
jobs:
  update-and-create-pr:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: "Install Nix"
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: "Set up Git credentials"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: "Run update script"
        id: run_script
        run: |
          chmod +x .github/workflows/update-dependencies.sh
          .github/workflows/update-dependencies.sh

          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
      - name: "Create Pull Request"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "build(deps): Automatic dependency updates for $(date --iso-8601)" \
            --body "This PR was automatically generated by a GitHub Action to update crate and flake dependencies. Please review the changes and merge." \
            --base main \
            --head ${{ steps.run_script.outputs.branch }}
